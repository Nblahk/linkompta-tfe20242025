@startuml Linkompta_Sequence_Upload_Document
!theme plain
title S√©quence d'upload et traitement d'un document\nLinkompta - Cas d'usage complet

' Acteurs et syst√®mes
actor "üë§ Client\n(Sophie Merle)" as Client
participant "üåê Frontend React" as Frontend
participant "üîß Backend Django" as Backend
participant "üíæ Base de donn√©es" as Database
participant "üìÅ Syst√®me fichiers" as FileSystem
actor "üë®‚Äçüíº Comptable\n(Paul Dupont)" as Comptable

' === Phase 1: Authentification ===
group Authentification
  Client -> Frontend : Se connecte (sophie.merle/password123)
  Frontend -> Backend : POST /users/login/
  Backend -> Database : V√©rification utilisateur
  Database -> Backend : Utilisateur valid√©
  Backend -> Frontend : JWT Token + Infos utilisateur
  Frontend -> Client : Redirection interface client
end

' === Phase 2: Upload document ===
group Upload de document
  Client -> Frontend : S√©lectionne fichier (facture.pdf)
  Frontend -> Backend : POST /documents/upload/\n+ Authorization Bearer Token
  Backend -> Database : V√©rification permissions client
  Database -> Backend : Client autoris√©
  Backend -> FileSystem : Stockage fichier s√©curis√©
  FileSystem -> Backend : Chemin fichier confirm√©
  Backend -> Database : INSERT document\n(title, file, client_id, status='envoye')
  Database -> Backend : Document ID cr√©√©
  Backend -> Frontend : 201 Created + Document info
  Frontend -> Client : ‚úÖ Document t√©l√©charg√© avec succ√®s
end

' === Phase 3: Notification comptable ===
group Notification au comptable
  Note over Backend : Le document est maintenant\ndisponible pour le comptable assign√©
  
  Comptable -> Frontend : Se connecte (comptable.paul.dupont/password123)
  Frontend -> Backend : POST /users/login/
  Backend -> Frontend : JWT Token comptable
  
  Comptable -> Frontend : Acc√®de √† "Documents"
  Frontend -> Backend : GET /documents/comptable/\n+ Authorization Bearer Token
  Backend -> Database : SELECT documents WHERE comptable=Paul
  Database -> Backend : Liste documents clients de Paul
  Backend -> Frontend : JSON documents avec infos clients
  Frontend -> Comptable : üìÑ Nouveau document de Sophie Merle
end

' === Phase 4: Traitement par le comptable ===
group Traitement du document
  Comptable -> Frontend : Consulte document Sophie
  Frontend -> Backend : GET /documents/{id}/\n+ Authorization Bearer Token
  Backend -> FileSystem : R√©cup√©ration fichier
  FileSystem -> Backend : Contenu fichier
  Backend -> Frontend : Document + m√©tadonn√©es
  Frontend -> Comptable : Affichage document PDF
  
  Comptable -> Frontend : Met √† jour statut "En cours"
  Frontend -> Backend : PATCH /documents/{id}/update-status/\n{"status": "en_cours"}
  Backend -> Database : UPDATE document SET status='en_cours'
  Database -> Backend : Statut mis √† jour
  Backend -> Frontend : 200 OK
  Frontend -> Comptable : ‚úÖ Statut mis √† jour
end

' === Phase 5: Finalisation ===
group Finalisation du traitement
  Note over Comptable : Apr√®s traitement comptable...
  
  Comptable -> Frontend : Marque "Trait√©"
  Frontend -> Backend : PATCH /documents/{id}/update-status/\n{"status": "traite"}
  Backend -> Database : UPDATE document SET status='traite'
  Database -> Backend : Document finalis√©
  Backend -> Frontend : Document trait√©
  Frontend -> Comptable : ‚úÖ Document finalis√©
  
  Note over Client : Le client peut maintenant voir\nle statut "Trait√©" sur son document
end

' Notes explicatives
note right of Client : Le client Sophie Merle\nupload ses documents\ncomptables
note right of Comptable : Paul Dupont traite\nles documents de\nses 8 clients assign√©s
note over Backend : S√©curit√© JWT:\nChaque requ√™te v√©rifi√©e\nPermissions par r√¥le
note over Database : Tra√ßabilit√© compl√®te:\nDate cr√©ation, statuts,\nauteur des modifications

@enduml
